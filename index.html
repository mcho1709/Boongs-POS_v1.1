<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Truck POS</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Check, Minus } = lucide;

        const MENU_ITEMS = [
          { name: 'Red Bean', defaultPrice: 5 },
          { name: 'Custard', defaultPrice: 5 },
          { name: 'Pizza', defaultPrice: 5 },
          { name: 'Matcha Red Bean', defaultPrice: 6 },
          { name: 'O-Maggie', defaultPrice: 7 },
          { name: 'Dubai Chocolate', defaultPrice: 7 },
          { name: 'Black Sesame', defaultPrice: 6 },
          { name: 'Chocolate', defaultPrice: 6 },
          { name: 'Spicy Pizza', defaultPrice: 6 },
          { name: 'Chestnut', defaultPrice: 6 },
          { name: 'Red Bean Mochi', defaultPrice: 6 },
          { name: 'Matcha Red Bean Mochi', defaultPrice: 7 },
          { name: 'Black Sesame Mochi', defaultPrice: 7 },
          { name: 'Dumpling', defaultPrice: 5 }
        ];

        function FoodTruckPOS() {
          const [screen, setScreen] = useState('setup');
          const [startingDocket, setStartingDocket] = useState('1');
          const [location, setLocation] = useState('');
          const [sessionDate, setSessionDate] = useState('');
          const [selectedMenus, setSelectedMenus] = useState([]);
          const [menuPrices, setMenuPrices] = useState({});
          const [currentDocketNumber, setCurrentDocketNumber] = useState(1);
          const [liveDockets, setLiveDockets] = useState([]);
          const [completedDockets, setCompletedDockets] = useState([]);
          const [completingDockets, setCompletingDockets] = useState([]);
          const [docketTimers, setDocketTimers] = useState({});
          const [currentOrder, setCurrentOrder] = useState({});
          const [confirmModal, setConfirmModal] = useState({ show: false, type: '', docketNumber: null });

          useEffect(() => {
            const prices = {};
            MENU_ITEMS.forEach(item => {
              prices[item.name] = item.defaultPrice;
            });
            setMenuPrices(prices);
          }, []);

          const toggleMenu = (menuName) => {
            if (selectedMenus.includes(menuName)) {
              setSelectedMenus(selectedMenus.filter(m => m !== menuName));
            } else {
              setSelectedMenus([...selectedMenus, menuName]);
            }
          };

          const updatePrice = (menuName, price) => {
            setMenuPrices({ ...menuPrices, [menuName]: parseFloat(price) || 0 });
          };

          const startSession = () => {
            if (selectedMenus.length === 0) {
              alert('Please select at least one menu item');
              return;
            }
            const today = new Date().toLocaleDateString('en-US', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
            setSessionDate(today);
            setCurrentDocketNumber(parseInt(startingDocket) || 1);
            setScreen('live');
          };

          const getNextDocketNumber = (current) => {
            const next = current + 1;
            return next > 100 ? 1 : next;
          };

          const formatDocketNumber = (num) => {
            return num.toString().padStart(3, '0');
          };

          const addToOrder = (menuName) => {
            setCurrentOrder({
              ...currentOrder,
              [menuName]: (currentOrder[menuName] || 0) + 1
            });
          };

          const removeFromOrder = (menuName) => {
            const newOrder = { ...currentOrder };
            if (newOrder[menuName] > 1) {
              newOrder[menuName]--;
            } else {
              delete newOrder[menuName];
            }
            setCurrentOrder(newOrder);
          };

          const submitOrder = () => {
            if (Object.keys(currentOrder).length === 0) {
              alert('Please add items to the order');
              return;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
              hour12: false, 
              hour: '2-digit', 
              minute: '2-digit', 
              second: '2-digit' 
            });

            const newDocket = {
              number: formatDocketNumber(currentDocketNumber),
              items: { ...currentOrder },
              total: Object.entries(currentOrder).reduce((sum, [item, qty]) => 
                sum + (menuPrices[item] * qty), 0),
              time: timeString
            };

            setLiveDockets([...liveDockets, newDocket]);
            setCurrentDocketNumber(getNextDocketNumber(currentDocketNumber));
            setCurrentOrder({});
          };

          const completeDocket = (docketNumber) => {
            const docket = liveDockets.find(d => d.number === docketNumber);
            if (docket && !completingDockets.includes(docketNumber)) {
              setCompletingDockets([...completingDockets, docketNumber]);
              
              const timerId = setTimeout(() => {
                setCompletingDockets(prev => prev.filter(d => d !== docketNumber));
                setCompletedDockets(prev => [...prev, docket]);
                setLiveDockets(prev => prev.filter(d => d.number !== docketNumber));
                setDocketTimers(prev => {
                  const newTimers = { ...prev };
                  delete newTimers[docketNumber];
                  return newTimers;
                });
              }, 5000);
              
              setDocketTimers(prev => ({ ...prev, [docketNumber]: timerId }));
            }
          };

          const revertDocket = (docketNumber) => {
            if (docketTimers[docketNumber]) {
              clearTimeout(docketTimers[docketNumber]);
              setDocketTimers(prev => {
                const newTimers = { ...prev };
                delete newTimers[docketNumber];
                return newTimers;
              });
            }
            setCompletingDockets(prev => prev.filter(d => d !== docketNumber));
          };

          const cancelDocket = (docketNumber) => {
            setConfirmModal({ show: true, type: 'cancel', docketNumber });
          };

          const confirmCancel = () => {
            const docketNumber = confirmModal.docketNumber;
            if (docketTimers[docketNumber]) {
              clearTimeout(docketTimers[docketNumber]);
              setDocketTimers(prev => {
                const newTimers = { ...prev };
                delete newTimers[docketNumber];
                return newTimers;
              });
            }
            setLiveDockets(prev => prev.filter(d => d.number !== docketNumber));
            setCompletingDockets(prev => prev.filter(d => d !== docketNumber));
            setConfirmModal({ show: false, type: '', docketNumber: null });
          };

          const resetData = () => {
            setConfirmModal({ show: true, type: 'reset', docketNumber: null });
          };

          const confirmReset = () => {
            setCompletedDockets([]);
            setLiveDockets([]);
            setCurrentOrder({});
            setConfirmModal({ show: false, type: '', docketNumber: null });
          };

          const getSortedItems = (items) => {
            const menuOrder = MENU_ITEMS.map(m => m.name);
            return Object.entries(items).sort((a, b) => {
              return menuOrder.indexOf(a[0]) - menuOrder.indexOf(b[0]);
            });
          };

          const getSummary = () => {
            const summary = {};
            let totalSales = 0;

            completedDockets.forEach(docket => {
              Object.entries(docket.items).forEach(([item, qty]) => {
                if (!summary[item]) {
                  summary[item] = { quantity: 0, amount: 0 };
                }
                summary[item].quantity += qty;
                summary[item].amount += qty * menuPrices[item];
                totalSales += qty * menuPrices[item];
              });
            });

            return { summary, totalSales };
          };

          if (screen === 'setup') {
            return (
              <div className="min-h-screen bg-gray-100 p-4">
                <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
                  <h1 className="text-3xl font-bold mb-6 text-center">Setup</h1>
                  
                  <div className="mb-6">
                    <label className="block text-lg font-semibold mb-2">Starting Docket Number</label>
                    <input
                      type="number"
                      value={startingDocket}
                      onChange={(e) => setStartingDocket(e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                      min="1"
                      max="100"
                    />
                  </div>

                  <div className="mb-6">
                    <label className="block text-lg font-semibold mb-2">Location</label>
                    <input
                      type="text"
                      value={location}
                      onChange={(e) => setLocation(e.target.value)}
                      placeholder="Enter location for record"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                    />
                  </div>

                  <div className="mb-6">
                    <h2 className="text-xl font-semibold mb-4">Select Menu Items & Set Prices</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {MENU_ITEMS.map(item => (
                        <div
                          key={item.name}
                          className={`p-4 border-2 rounded-lg cursor-pointer transition ${
                            selectedMenus.includes(item.name)
                              ? 'border-blue-500 bg-blue-50'
                              : 'border-gray-300 bg-white'
                          }`}
                          onClick={() => toggleMenu(item.name)}
                        >
                          <div className="flex justify-between items-center mb-2">
                            <span className="font-semibold">{item.name}</span>
                            <div className="flex items-center gap-2">
                              <span className="text-sm">$</span>
                              <input
                                type="number"
                                value={menuPrices[item.name] || ''}
                                onChange={(e) => {
                                  e.stopPropagation();
                                  updatePrice(item.name, e.target.value);
                                }}
                                onClick={(e) => e.stopPropagation()}
                                className="w-16 p-1 border border-gray-300 rounded text-center"
                                step="0.5"
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <button
                    onClick={startSession}
                    className="w-full bg-green-500 text-white py-4 rounded-lg text-xl font-bold hover:bg-green-600 transition"
                  >
                    Start Session
                  </button>
                </div>
              </div>
            );
          }

          if (screen === 'live') {
            const orderTotal = Object.entries(currentOrder).reduce((sum, [item, qty]) => 
              sum + (menuPrices[item] * qty), 0);

            return (
              <div className="min-h-screen bg-gray-100">
                {confirmModal.show && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-sm mx-4">
                      <h3 className="text-xl font-bold mb-4">
                        {confirmModal.type === 'cancel' 
                          ? `Cancel Docket #${confirmModal.docketNumber}?` 
                          : 'Reset All Data?'}
                      </h3>
                      <p className="mb-6 text-gray-600">
                        {confirmModal.type === 'cancel'
                          ? 'This docket will be permanently deleted.'
                          : 'All sales data will be permanently deleted.'}
                      </p>
                      <div className="flex gap-3">
                        <button
                          onClick={() => setConfirmModal({ show: false, type: '', docketNumber: null })}
                          className="flex-1 bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400"
                        >
                          Cancel
                        </button>
                        <button
                          onClick={confirmModal.type === 'cancel' ? confirmCancel : confirmReset}
                          className="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600"
                        >
                          Confirm
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                <div className="bg-blue-600 text-white p-4 flex justify-between items-center">
                  <h1 className="text-2xl font-bold">Live Dockets - {location}</h1>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setScreen('summary')}
                      className="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100"
                    >
                      Summary
                    </button>
                    <button
                      onClick={() => setScreen('setup')}
                      className="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600"
                    >
                      Setup
                    </button>
                  </div>
                </div>

                <div className="p-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                      <h2 className="text-2xl font-bold mb-4">New Order - Docket #{formatDocketNumber(currentDocketNumber)}</h2>
                      
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        {selectedMenus.map(menu => (
                          <button
                            key={menu}
                            onClick={() => addToOrder(menu)}
                            className="bg-blue-500 text-white p-4 rounded-lg font-semibold hover:bg-blue-600 transition"
                          >
                            {menu}
                            <div className="text-sm">${menuPrices[menu]}</div>
                          </button>
                        ))}
                      </div>

                      {Object.keys(currentOrder).length > 0 && (
                        <div className="border-t-2 pt-4">
                          <h3 className="font-bold mb-2">Current Order:</h3>
                          {getSortedItems(currentOrder).map(([item, qty]) => (
                            <div key={item} className="flex justify-between items-center mb-2">
                              <span>{item} x {qty}</span>
                              <div className="flex items-center gap-2">
                                <span className="font-semibold">${(menuPrices[item] * qty).toFixed(2)}</span>
                                <button
                                  onClick={() => removeFromOrder(item)}
                                  className="bg-red-500 text-white p-1 rounded hover:bg-red-600"
                                >
                                  <Minus size={16} />
                                </button>
                              </div>
                            </div>
                          ))}
                          <div className="border-t-2 mt-2 pt-2 flex justify-between text-xl font-bold">
                            <span>Total:</span>
                            <span>${orderTotal.toFixed(2)}</span>
                          </div>
                          <button
                            onClick={submitOrder}
                            className="w-full bg-green-500 text-white py-3 rounded-lg font-bold mt-4 hover:bg-green-600 transition"
                          >
                            Submit Order
                          </button>
                        </div>
                      )}
                    </div>
                  </div>

                  <div>
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <h2 className="text-2xl font-bold mb-4">Waiting Dockets ({liveDockets.length})</h2>
                      <div className="space-y-3">
                        {liveDockets.map(docket => {
                          const isCompleting = completingDockets.includes(docket.number);
                          return (
                            <div 
                              key={docket.number} 
                              className={`border-2 p-4 rounded-lg relative transition-all ${
                                isCompleting 
                                  ? 'border-green-400 bg-green-50' 
                                  : 'border-orange-400 bg-orange-50'
                              }`}
                            >
                              {isCompleting && (
                                <div className="absolute inset-0 flex items-center justify-center z-10 backdrop-blur-none">
                                  <button
                                    onClick={() => revertDocket(docket.number)}
                                    className="bg-yellow-500 text-white px-8 py-4 rounded-lg font-bold text-xl hover:bg-yellow-600 shadow-xl"
                                  >
                                    UNDO
                                  </button>
                                </div>
                              )}
                              <div className={isCompleting ? '' : ''}>
                                <div className="flex justify-between items-center mb-2">
                                  <div>
                                    <span className="text-2xl font-bold">#{docket.number}</span>
                                    <div className="text-sm text-gray-600">{docket.time}</div>
                                  </div>
                                  {!isCompleting && (
                                    <div className="flex gap-2">
                                      <button
                                        onClick={(e) => {
                                          e.preventDefault();
                                          e.stopPropagation();
                                          cancelDocket(docket.number);
                                        }}
                                        className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm font-semibold"
                                      >
                                        Cancel
                                      </button>
                                      <button
                                        onClick={() => completeDocket(docket.number)}
                                        className="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600"
                                      >
                                        <Check size={20} />
                                      </button>
                                    </div>
                                  )}
                                </div>
                                <div className={isCompleting ? 'blur-sm opacity-60' : ''}>
                                  {getSortedItems(docket.items).map(([item, qty]) => (
                                    <div key={item} className="text-sm">
                                      {item} x {qty}
                                    </div>
                                  ))}
                                  <div className="text-lg font-bold mt-2">Total: ${docket.total.toFixed(2)}</div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (screen === 'summary') {
            const { summary, totalSales } = getSummary();

            return (
              <div className="min-h-screen bg-gray-100">
                {confirmModal.show && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-sm mx-4">
                      <h3 className="text-xl font-bold mb-4">Reset All Data?</h3>
                      <p className="mb-6 text-gray-600">All sales data will be permanently deleted. This cannot be undone.</p>
                      <div className="flex gap-3">
                        <button
                          onClick={() => setConfirmModal({ show: false, type: '', docketNumber: null })}
                          className="flex-1 bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400"
                        >
                          Cancel
                        </button>
                        <button
                          onClick={confirmReset}
                          className="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600"
                        >
                          Confirm
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                <div className="bg-green-600 text-white p-4 flex justify-between items-center">
                  <h1 className="text-2xl font-bold">Sales Summary - {location}</h1>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setScreen('live')}
                      className="bg-white text-green-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100"
                    >
                      Live Dockets
                    </button>
                    <button
                      onClick={resetData}
                      className="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600"
                    >
                      Reset Data
                    </button>
                  </div>
                </div>

                <div className="p-4 max-w-4xl mx-auto">
                  <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <div className="mb-4 text-gray-600">
                      <div className="text-lg font-semibold">{sessionDate}</div>
                      <div className="text-md">Location: {location || 'Not specified'}</div>
                    </div>
                    <h2 className="text-3xl font-bold mb-2">Total Sales</h2>
                    <div className="text-4xl font-bold text-green-600">${totalSales.toFixed(2)}</div>
                    <div className="text-gray-600 mt-2">Completed Orders: {completedDockets.length}</div>
                  </div>

                  <div className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4">Menu Breakdown</h2>
                    <div className="space-y-3">
                      {Object.entries(summary).map(([item, data]) => (
                        <div key={item} className="border-b pb-3">
                          <div className="flex justify-between items-center">
                            <span className="font-semibold text-lg">{item}</span>
                            <div className="text-right">
                              <div className="font-bold text-xl">${data.amount.toFixed(2)}</div>
                              <div className="text-sm text-gray-600">Qty: {data.quantity}</div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="bg-white rounded-lg shadow-lg p-6 mt-4">
                    <h2 className="text-2xl font-bold mb-4">Last 20 Dockets</h2>
                    <div className="space-y-3">
                      {completedDockets.slice(-20).reverse().map(docket => (
                        <div key={docket.number} className="border-l-4 border-green-500 bg-gray-50 p-4 rounded">
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <span className="text-xl font-bold">#{docket.number}</span>
                              <span className="text-sm text-gray-600 ml-3">{docket.time}</span>
                            </div>
                            <div className="text-lg font-bold text-green-600">${docket.total.toFixed(2)}</div>
                          </div>
                          <div className="text-sm space-y-1">
                            {getSortedItems(docket.items).map(([item, qty]) => (
                              <div key={item} className="text-gray-700">
                                {item} x {qty}
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                      {completedDockets.length === 0 && (
                        <div className="text-center text-gray-400 py-8">No completed dockets yet</div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            );
          }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FoodTruckPOS />);
    </script>
</body>
</html>